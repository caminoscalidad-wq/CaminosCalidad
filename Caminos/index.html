<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caminos Calidad Providencia - Sistema de Optimización de Rutas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Sistema de planificación de rutas optimizadas para transporte agrícola del Ingenio Providencia">
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
    <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>
    
    <!-- Font Awesome & Material Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Nuestros estilos CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- Estado de la aplicación -->
    <div class="app-state" id="app-state">
        <i class="fas fa-circle" style="color: #4CAF50; font-size: 0.5rem;"></i>
        <span>Sistema listo</span>
    </div>

    <!-- Notificación de bloqueo -->
    <div class="block-notification" id="block-notification">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="block-notification-text"></span>
    </div>

    <!-- Notificaciones Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Operación completada</span>
    </div>

    <!-- Estado GPS -->
    <div id="gps-status">
        <i class="fas fa-satellite"></i>
        <span id="gps-status-text">GPS desconectado</span>
    </div>

    <!-- Agregar después del estado GPS -->
<div id="gps-status">
    <i class="fas fa-satellite"></i>
    <span id="gps-status-text">GPS desconectado</span>
</div>

<!-- NUEVO: Panel de seguimiento en tiempo real -->
<div class="tracking-panel" id="tracking-panel">
    <div class="tracking-info">
        <div class="tracking-distance">
            <i class="fas fa-road"></i>
            <span id="tracking-distance">0.0 km</span>
        </div>
        <div class="tracking-time">
            <i class="fas fa-clock"></i>
            <span id="tracking-time">--:--</span> restantes
        </div>
    </div>
    <div class="tracking-progress">
        <div class="progress-circle" id="progress-circle">
            <svg width="50" height="50" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#333" stroke-width="4"/>
                <circle cx="25" cy="25" r="20" fill="none" stroke="#4CAF50" 
                        stroke-width="4" stroke-linecap="round"
                        id="progress-circle-fill"/>
            </svg>
            <div class="progress-text" id="progress-circle-text">0%</div>
        </div>
    </div>
</div>

    <!-- Contenedor principal -->
    <div id="app-container">
        <!-- Botón toggle sidebar (móvil) -->
        <button id="sidebar-toggle" onclick="UIManager.toggleSidebar()">
            <i class="fas fa-route"></i>
        </button>

        <!-- Panel de instrucciones flotante -->
        <div id="floating-directions">
            <div id="drag-handle">
                <span><i class="fas fa-directions"></i> Instrucciones de Ruta</span>
                <button id="close-float-btn" onclick="UIManager.toggleInstrucciones(false)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="route-summary" id="route-summary">
                <!-- Resumen de ruta dinámico -->
            </div>
            <div id="directions-content"></div>
            <div class="route-progress" id="route-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span>Progreso de ruta</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="VoiceNavigation.speakInstructions()" style="padding: 8px 12px; font-size: 0.8rem; flex: 1;">
                        <i class="fas fa-volume-up"></i> Leer Instrucciones
                    </button>
                    <button onclick="VoiceNavigation.stopSpeaking()" style="padding: 8px 12px; font-size: 0.8rem; flex: 1;">
                        <i class="fas fa-stop"></i> Detener Voz
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar principal -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="fas fa-tractor"></i>
                    </div>
                    <div>
                        <h1>Caminos Calidad</h1>
                        <div class="sidebar-subtitle">Optimización de Rutas • Ingenio Providencia</div>
                    </div>
                </div>
                <button class="close-sidebar-btn" onclick="UIManager.toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Sección Origen -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Punto de Origen</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación inicial</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-origen" placeholder="Buscar hacienda o ubicación..." 
                                   onkeyup="SearchManager.buscar('origen')" autocomplete="off">
                        </div>
                        <ul id="list-origen" class="search-results"></ul>
                        <div class="btn-group">
                            <button class="btn-gps" onclick="GPSTracker.locateMe()">
                                <i class="fas fa-crosshairs"></i> Seguir GPS
                            </button>
                            <button class="btn-secondary" onclick="MapManager.activarManual('origen')">
                                <i class="fas fa-hand-pointer"></i> Seleccionar
                            </button>
                        </div>
                        <div class="form-info">
                            <small style="color: var(--prov-gray-medium); display: block; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> Seleccione ubicación inicial de transporte
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Sección Paradas Intermedias -->
                <div class="section-card" id="stopover-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="section-title" style="margin: 0;">
                            <i class="fas fa-map-pin"></i>
                            <h2>Parada Intermedia</h2>
                        </div>
                        <button class="btn-link" style="color: #e74c3c;" onclick="UIManager.toggleParada(false)">
                            <i class="fas fa-times"></i> Quitar
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación intermedia</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-inter" placeholder="Buscar parada..." 
                                   onkeyup="SearchManager.buscar('inter')" autocomplete="off">
                        </div>
                        <ul id="list-inter" class="search-results"></ul>
                        <button class="btn-secondary" onclick="MapManager.activarManual('inter')">
                            <i class="fas fa-hand-pointer"></i> Seleccionar en mapa
                        </button>
                    </div>
                </div>

                <!-- Botón para agregar parada -->
                <button id="btn-add-stop" class="btn-link" onclick="UIManager.toggleParada(true)" 
                        style="margin-bottom: 20px; padding: 10px 0;">
                    <i class="fas fa-plus-circle"></i> Agregar parada intermedia (opcional)
                </button>

                <!-- Sección Destino -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-flag-checkered"></i>
                        <h2>Destino Final</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación de destino</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-dest" placeholder="Buscar hacienda..." 
                                   onkeyup="SearchManager.buscar('dest')" autocomplete="off">
                        </div>
                        <ul id="list-dest" class="search-results"></ul>
                        <button class="btn-secondary" onclick="MapManager.activarManual('dest')">
                            <i class="fas fa-hand-pointer"></i> Seleccionar en mapa
                        </button>
                    </div>
                </div>

                <!-- Información de Ruta Calculada -->
                <div class="section-card" id="route-info" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        <h2>Resumen de Ruta</h2>
                    </div>
                    <div id="route-details">
                        <!-- Detalles de ruta dinámicos -->
                    </div>
                </div>

                <!-- Instrucciones para móvil -->
                <div id="mobile-instructions" style="display: none;">
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-directions"></i>
                            <h2>Instrucciones de Ruta</h2>
                        </div>
                        <div id="mobile-directions-content"></div>
                        <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="VoiceNavigation.speakInstructions()" style="width: 100%; padding: 12px;">
                                <i class="fas fa-volume-up"></i> Leer Instrucciones
                            </button>
                            <button onclick="VoiceNavigation.stopSpeaking()" style="width: 100%; padding: 12px;">
                                <i class="fas fa-stop"></i> Detener Voz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción principales -->
                <button class="btn-primary" onclick="RouteCalculator.calcularRuta()">
                    <i class="fas fa-route loading" id="route-loading" style="display: none;"></i>
                    <i class="fas fa-route" id="route-icon"></i>
                    <span id="route-text">CALCULAR RUTA ÓPTIMA</span>
                </button>

                <button id="btn-alt" class="btn-alt" onclick="RouteCalculator.cambiarRutaAlternativa()" style="display: none;">
                    <i class="fas fa-exchange-alt"></i>
                    <span id="alt-text">Cambiar Ruta</span>
                </button>

                <button id="btn-instr" class="btn-primary btn-instr-sidebar" onclick="UIManager.toggleInstrucciones(true)" 
                        style="display: none; margin-top: 10px;">
                    <i class="fas fa-directions"></i> Ver Instrucciones Detalladas
                </button>

                <button class="btn-danger" onclick="AppState.limpiarTodo()">
                    <i class="fas fa-redo"></i> Nueva Consulta
                </button>

                <!-- Información de la app -->
                <div style="padding: 20px 0; text-align: center; font-size: 0.8rem; color: var(--prov-gray-medium);">
                    <div style="margin-bottom: 8px;">
                        <i class="fas fa-leaf" style="color: var(--prov-green-main);"></i>
                        <span>Sistema de Optimización de Rutas</span>
                    </div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">
                        Ingenio Providencia &copy; 2025 • v2.3.0
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mapa principal -->
        <main id="map-wrapper">
            <!-- Controles personalizados -->
            <div class="custom-controls-container">
                <button class="custom-control-btn" id="btn-north" onclick="MapManager.resetNorth()" title="Reorientar al Norte">
                    <i class="fas fa-compass"></i>
                </button>
                <button class="custom-control-btn" id="btn-layers" onclick="UIManager.toggleLayerControls()" title="Controles de Capas">
                    <i class="fas fa-layer-group"></i>
                </button>
                <button class="custom-control-btn" id="btn-traffic" onclick="UIManager.toggleTraffic()" title="Mostrar/Ocultar Tráfico">
                    <i class="fas fa-traffic-light"></i>
                </button>
                <button class="custom-control-btn" id="btn-block" onclick="UIManager.toggleBlockMode()" title="Bloquear/Desbloquear Haciendas">
                    <i class="fas fa-lock"></i>
                </button>
            </div>

            <!-- Panel de controles de capas -->
            <div class="layer-controls" id="layer-controls">
                <h4>Controles de Capas</h4>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-tractor"></i>
                        <span>Haciendas</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-haciendas" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-road"></i>
                        <span>Carreteras</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-calles" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-satellite"></i>
                        <span>Vista Satélite</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-satelite">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-mountain"></i>
                        <span>Topográfico</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-topografico">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="map"></div>
        </main>
    </div>

    <!-- Cargar JavaScript en orden de dependencia -->
    <script src="js/constants.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="app-constants.js"></script>
    <script src="js/map-manager.js"></script>
    <script src="js/gps-tracker.js"></script>
    <script src="js/search-manager.js"></script>
    <script src="js/route-calculator.js"></script>
    <script src="js/voice-navigation.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/app.js"></script>
    

</body>
</html>